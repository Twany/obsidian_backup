### 支付架构
[支付系统就该这么设计，稳的一批！！ (qq.com)](https://mp.weixin.qq.com/s/Sp2nROiAS_JvPIKDEl_Zcw)
https://mp.weixin.qq.com/s/wCi0QR9W95npvcAK-_TbuA
https://mp.weixin.qq.com/s/cVoTPYyccMa-YKmqmxDeTw
![[image-20230628234306096.png|475]]


![[image-20230627224138397.png|800]]

### 说一下整个后台支付架构，分了几个模块

### 后端如何避免订单重复提交
![[image-20230627230114448.png]]
有三道门槛
#### 1. 前端防抖
如果没有做可能会产生点返回会有两个相同界面
做防抖：控制用户100ms内只能做一次提交订单提交
#### 2. 后端频控
使用Redis+Lua实现分布式锁，每个请求生成一个token，请求来了查缓存，有就说明最近刚提交，拒绝掉
#### 3. 数据库幂等
**这个out_trade_id 如何生成的，如果用户来了两次相同的请求来呢？**

out_trade_id是唯一的，保证唯一性
生成out_trade_id一定唯一，因为会重试最多5次，直到生成一个唯一的id

同时使用订单和流水的状态机来保证唯一：初始，支付中，失败，成功；每次进行新的操作都会去查当前订单和流水的状态（有的方法内部还会重新查交易单，而不是传过来的）

### 用户支付前订单状态发送改变吗？
即prePay 在具体之前前

### 说一下一个完整的支付流程：从用户下单开始到最终支付回调结束
> 或者说是一个订单的全流程周期，包括退款

### 使用到了什么设计模式，体现在哪？
支付信息的构建：构建者模式 builder

### 多笔订单如何处理？

### 券和余额
> 很复杂，摸透具体逻辑

余额，上来就冻结，防止其他订单透支
券，上来就使用冻结，用户
### 如何保证券冻结、关流水、支付的一致性？
分布式事务？


### callback谁调用

### 订单量很大，如何保证下单成功？
- 加机器，负载均衡
- 了解下秒杀如何处理（飞书）

### 对内网关，如果支付成功了，但是通知业务层失败（用户关闭了），怎么处理（所谓的掉单）？
1. MQ，异步通知
2. 持久化存储起来，等下次时机合适重发：Redis+Netty
	1. 引入xxl-job重发
3. http重复（支付宝是这样做的)

### 其他的掉单如何处理，就是支付失败场景
1. 查询订单状态


### 分控是什么？做了什么 举例
#### 订单风控

#### 支付风控

#### 其他维度风控
### 因为支付没有做过，可能面试官不会主动问起某些话题 这个时候就要说：
我对这些很感兴趣，所以当时也了解了下 balabala...

### 加密算法有哪些？对称还是非对称

### 那用到了MQ

### 服务峰值多少？平均值多少？几个机器 几个Redis


### 数据库主从架构是怎么做的

---
### 订单超时未消费如何
![[image-20230628214526813.png|575]]
其他方式有没有思路？
- 懒查询，每次来看有么有过期 过期再删除
- 分布式任务 xxl-job
- Redis实现 setnx，过期了再删除
- 扫表轮询

